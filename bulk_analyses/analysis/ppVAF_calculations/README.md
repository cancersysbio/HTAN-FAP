## Estimating ppVAFs and counting clonal SNVs

This folder contains scripts for estimating ppVAFs for each somatic mutation in the filtered mafs, using the HTAN scATAC-seq cell type data. Please run the filtering scripts in `analysis/mutation_postprocessing` first to generate filtered mafs with copy number calls without ppVAF values. Please run these notebooks in the order they are presented below to reproduce these steps.

### Description of scripts

`ppVAF_utils.py`

Contains helper functions used in multiple notebooks in this repo. Does not need to be run on its own!

`scATACseq_sample_purity.ipynb`

Computes and saves sample purity (i.e., epithelial cell fractions) from the scATAC-seq data tables.

Requires:
* Published scATAC-seq cell barcode and annotation tables (in this repo at `data/scATACseq_annotations/*celltype_atac.tsv`)

Generates:
* Pickled Python dictionary with smoothed sample purity distributions by sample type (in this repo at `data/scATACseq_annotations/scATAC_purities.p`)
* Simplified data table with cell type fractions for each sample (in this repo at `data/scATACseq_annotations/scATAC_celltype_fracs.csv`)

`calculate_ppVAF_posteriors.py`

Computes intermediate data matrices with unnormalized ppVAF posterior values for individual patients in each cohort given a combined maf file. See comment at the top of the script for more info on how to run this script. This script can take a lot of memory to run!

Requires:
* maf file annotated with copy number data to be processed (e.g., outputs of `analysis/mutation_postprocessing/add_CN_mafs.ipynb`)

Generates:
* .npy matrix file containing unnormalized ppVAF posterior probabilities for each mutation for the patient specified as input
* .csv patient specific mutation file with the same columns as in the original maf, with mutations in the same order as in the 3rd dimension of the .npy matrix for further processing

`process_unnormalized_ppVAFs.ipynb`

Normalizes ppVAFs computed by `calculate_ppVAF_posteriors.py` and generates final mafs with ppVAF values as a column.

Requires:
* .npy matrices and .csv patient specific mutation tables generated by `calculate_ppVAF_posteriors.py` for each patient to be added to the final mafs
* Pickled Python dictionary with smoothed sample purity distributions by sample type (in this repo at `data/scATACseq_annotations/scATAC_purities.p`)

Generates:
* filtered HTAN WGS and WES mafs with ppVAFs (found in Zenodo dataset as `HTAN_WGS_filtered_ppVAFs.maf` and `HTAN_WES_filtered_ppVAFs.maf`)
* optionally, SCORT and PUTH external cohort mafs with ppVAFs, if using them in previous steps
* APC/KRAS mutation marginalized posterior ppVAF distributions (found in Zenodo dataset as `*_marginals_WGS.csv` and `*_marginals_WES.csv`)

`SI_Text_purity_sims.py`

Simulates ground-truth monoclonal samples with specified purities using mucosal samples from HTAN WGS data and simulated clonal mutations and computes their estimated clonal SNV counts and resulting monoclonal/polyclonal classifications using our pipeline. See Supplementary Note 2 for more info.

Requires:
* filtered HTAN WGS (found in Zenodo dataset as `HTAN_WGS_filtered_ppVAFs.maf` and `HTAN_WES_filtered_ppVAFs.maf`)
* monoclonal/polyclonal classifications (HTAN calls in this repo at `data/clonal_count_estimation/clonal_SNVs_WES_WGS.csv`)
* pickled scATAC-seq purity distribution dictionary (in this repo at `data/scATACseq_annotations/scATAC_purities.p`)
* simulated clonal mutation mafs needed for clonal/subclonal classifier (in this repo at `data/clonal_count_estimation/simulated_clonal_WGS.csv`)

Generates:
* clonal SNV counts and monoclonal/polyclonal classifications for simulated monoclonal WGS samples with specified sample purities (in this repo at `data/purity_sims/`)
