---
title: "Telomere length and clonality - ED Figure 9"
author: 
  - name: "Aziz Khan"
    affiliation: "Stanford Cancer Institute, Stanford University"
    email: "azizk@stanford.edu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
---

## Setup the base paths
```{r setup}

set.seed(4321)
# Set the base path to the FAP-HTAN github repo
main_repo_path <- "~/stanford/projects/FAP/HTAN-FAP"

# Paths to data and output directories
data_path <- file.path(main_repo_path, "data")
output_path <- file.path(main_repo_path, "reproduce")

if ((!exists("main_repo_path")) | main_repo_path == "") {
  stop("Error: Path for main GitHub repo is not set. Please set main_repo_path <- '/path/to/repo/HTAN-FAP' and try again!")
}

# Create output directory to save the plots if it doesn't exist
if (!dir.exists(output_path)) {
  dir.create(output_path)
}
```

## Load the required packages

```{r load-packages, include=FALSE}
library(dplyr)
library(ggpubr)
library(stats)
library(multtest)
library(metap)
```



## Read telomere length estimates data
Load the TelSeq estimates using the FF WGS data 
```{r}

## These are 
telseq_joint <- read.table(paste0(main_repo_path,"/data/telseq_estimates_wgs_ff_monoploy.tsv"), sep = "\t", header = TRUE)

head(telseq_joint)

# color plate for monoclonal and polyclonal in each stage
mono_ploy_plate <- list(
  Mucosa=c("#66C2A5"),
  Benign=c("#fc5a2f","#fcc095"),
  Dysplasia=c("#5a6d98","#c0d3fe")
)

mono_ploy_plate_all <- c("#66C2A5","#fc5a2f","#fcc095","#5a6d98","#c0d3fe")
```


## TL estimates per-patient

```{r, fig.width= 12, fig.height= 6}

telseq_joint_patients <- telseq_joint %>% 
  mutate(StageGroup=paste0(Stage,"",Group))

telseq_joint_patients$StageGroup <- factor(telseq_joint_patients$StageGroup, levels = c("MucosaPoly", "BenignPoly", "BenignMono", "DysplasiaPoly", "DysplasiaMono"))

## Order the patients by age on colectomy (check supplementary table 1 for more details)
telseq_joint_patients$Patient <- factor(telseq_joint_patients$Patient, levels = c("A002","A014", "F001","G001","A015","A001"))

telseq_patients.plt <- ggboxplot(telseq_joint_patients, x = "Patient", y="TL",
   #add = "mean",
   rug = F,
   color = "StageGroup",
   #fill = "Group",
   add = "jitter",
   palette = mono_ploy_plate_all,
   xlab="", ylab = "Telomere length estimate (kb)",
   ) + stat_compare_means(comparisons =  list(c("DysplasiaPoly", "DysplasiaMono")), label = "p.format", paired=F, method = "wilcox.test", method.args = list(alternative = "two.sided")) + ylim(0, 7) 

telseq_patients.plt

## save the plot
ggsave(paste0(output_path,"/ED_Figure_9.pdf"), telseq_patients.plt, width = 12, height = 6)

```

## Combined boxplot of mono vs poly samples


```{r}
tel.mucosa.pl <- list()

for(stage in c("Mucosa","Benign","Dysplasia")){
  
tel.mucosa.pl[[stage]] <- ggboxplot(telseq_joint %>% filter(Stage == stage), x = "Group", y="TL",
   #add = "mean",
   rug = F,
   color = "Group",
   #fill = "Group",
   add = "jitter",
   palette = mono_ploy_plate[[stage]],
   xlab="", ylab = "Telomere length estimate (kb)", title = stage,
   ) + stat_compare_means(comparisons =  list(c("Poly", "Mono")), label = "p.format", paired=F, method = "wilcox.test", method.args = list(alternative = "two.sided")) + ylim(0, 7) #+ facet_grid(.~Stage, scale="free_x", space="free_x")
}

telseq_combined.plt <- ggarrange(plotlist = tel.mucosa.pl, ncol = 3, widths = c(1.3,2,2))
telseq_combined.plt
ggsave(paste0(output_path,"/ED_Figure_9_extra.pdf"), telseq_combined.plt, width = 8, height = 6)

```


## Calculate combined p-value

Estimate the combined p-value using Fisher's method which is adjusted for patients. It requires at least two data points to calculate the p-value. It also calculates the p-value using Stouffer's Z-score.
We reported Fisher's p-value in the paper.

```{r}
# Perform individual comparisons
for (stage in unique(telseq_joint$Stage)) {
  print(stage)
  p_values <- c()
  for (patient in unique(telseq_joint$Patient)) {
    subset <- filter(telseq_joint, Patient == patient, Stage == stage)
    if (length(unique(subset$Group)) == 2) { 
      mono <- subset %>% filter(Group == 'Mono') %>% pull(TL)
      poly <- subset %>% filter(Group == 'Poly') %>% pull(TL)
      # there should be at least two data points to calculate the p-value
      if (length(mono) > 1 & length(poly) > 1) { 
        test_result <- wilcox.test(mono, poly, alternative="two.sided")
        print(paste(patient, stage," p=",test_result$p.value))
        p_values <- c(p_values, test_result$p.value)
      }
    }
  }
  
# Combine p-values using Fisher's method
combined_p_value_fisher <- sumlog(p_values)$p
print(paste0("Fisher's method:", combined_p_value_fisher))

# Stouffer's Z-score method
combined_p_value_stouffer <- sumz(p_values)$p
print(paste0("Stouffer's Z-score:", combined_p_value_stouffer))
  
}

```

## Show session information
```{r session-info}
sessionInfo()
```

